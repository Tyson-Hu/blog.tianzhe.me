<!DOCTYPE html><html lang="[&quot;en&quot;,&quot;zh-CN&quot;,&quot;default&quot;]" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Consensus Algorithm - Raft | Tyson's blog</title><meta name="author" content="Tyson Hu"><meta name="copyright" content="Tyson Hu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Part notes for Raft">
<meta property="og:type" content="article">
<meta property="og:title" content="Consensus Algorithm - Raft">
<meta property="og:url" content="https://blog.tianzhe.me/en/Raft/index.html">
<meta property="og:site_name" content="Tyson&#39;s blog">
<meta property="og:description" content="Part notes for Raft">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raft.github.io/logo/solo.svg">
<meta property="article:published_time" content="2023-05-02T13:57:01.000Z">
<meta property="article:modified_time" content="2023-05-08T15:10:23.000Z">
<meta property="article:author" content="Tyson Hu">
<meta property="article:tag" content="Algorithm">
<meta property="article:tag" content="C++">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raft.github.io/logo/solo.svg"><link rel="shortcut icon" href="/img/favicon.jpeg"><link rel="canonical" href="https://blog.tianzhe.me/en/Raft/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="E3ldS1S2QwwG6Wt7hTzCzP8cEsZe4qy7GuQn5C9D5Fk"/><meta name="baidu-site-verification" content="RZuOf3nNVc"/><meta name="bing_site_verification" content="E3ldS1S2QwwG6Wt7hTzCzP8cEsZe4qy7GuQn5C9D5Fk"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Consensus Algorithm - Raft',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2023-05-08 11:10:23'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#212121')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="https://avatars1.githubusercontent.com/u/62329498?s=400&amp;u=20198ec972904a758bc5f6ba4888c5ac6b6270fb&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">34</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">29</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页 / Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴 / Arch</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签 / Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类 / Ctgy</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> 留言板 / MsgBoard</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 好友 / Frds</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于👴 / About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raft.github.io/logo/solo.svg')"><nav id="nav"><span id="blog-info"><a href="/" title="Tyson's blog"><span class="site-name">Tyson's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页 / Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴 / Arch</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签 / Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类 / Ctgy</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> 留言板 / MsgBoard</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 好友 / Frds</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于👴 / About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Consensus Algorithm - Raft</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-05-02T13:57:01.000Z" title="Created 2023-05-02 09:57:01">2023-05-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-05-08T15:10:23.000Z" title="Updated 2023-05-08 11:10:23">2023-05-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Algorithm/">Algorithm</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Algorithm/C/">C++</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">6.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>41mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Consensus Algorithm - Raft"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/en/Raft/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>All contents are modified and cite from the paper “In Search of an Understandable Consensus Algorithm (Extended Version)” by Diego Ongaro and John Ousterhout at Stanford University. It could be checked on the <a target="_blank" rel="noopener" href="https://raft.github.io/">Raft consensus algorithm website</a>. <em>For a Chinese translate version, check <a target="_blank" rel="noopener" href="https://bugwz.com/2021/05/01/raft/#1%E3%80%81%E4%BB%8B%E7%BB%8D">译 - In Search of an Understandable Consensus Algorithm (Extended Version) | 咕咕 (bugwz.com)</a></em>.</p>
<p><em>This only talk parts of the paper, for full version check paper directly!</em></p>
<h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>Raft is a consensus algorithm for managing a replicated log. It produces a result equivalent to (multi-)Paxos, and it is as efficient as Paxos, but with a more understandable structure than Paxos.</p>
<p>Raft is similar in many ways to existing consensus algorithms, but it has several novel features:</p>
<ul>
<li>Strong leader: Raft uses a stronger form of leadership than other consensus algorithms. Ex. It simplifies the management of the replicated log by set log entries only flow from the leader to other servers.</li>
<li>Leader election: Raft uses randomized timers to elect leaders. This adds some mechanism based on the heartbeats(Implemented on PA1) from usual consensus algorithm, which makes conflicts resolve simply and rapidly.</li>
<li>Membership changes: Raft uses a new joint consensus approach for the mechanism of changing the set of server in the cluster. The majorities of two different configurations overlap during transitions which allows the cluster to continue operating normally during configuration changes.</li>
</ul>
<h1 id="Replicated-state-machines"><a href="#Replicated-state-machines" class="headerlink" title="Replicated state machines"></a>Replicated state machines</h1><p>Replicated state machines are used to solve a variety of fault tolerance problems in distributed system since it is a collection of servers compute identical copies of the same state that used to replace the servers who is  down which make system could continue operating.</p>
<h2 id="How-does-it-be-replicated"><a href="#How-does-it-be-replicated" class="headerlink" title="How does it be replicated?"></a>How does it be replicated?</h2><p>The consensus algorithm manages a replicated log containing state machine commands from clients. The state machines process identical sequences of commands from the logs, so they produce the same outputs.</p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230425181354934.png" alt="Replicated state machines structure"></p>
<p>As shown in figure above, replicated state machines are typically implemented using a replicated log:</p>
<ol>
<li>Each server stores a log containing a series of commands, which its state machine executes in order.</li>
<li>Each log contains the same commands in the same order, so each state machine processes the same sequence of commands.</li>
<li>Since the state machines are deterministic, each computes the sam estate and the same sequence of outputs.</li>
</ol>
<p>Keeping the replicated log consistent is the job of the consensus algorithm. The consensus module on a server receives commands from clients and adds them to its log, then communicates with the consensus modules on other servers to ensure that every log eventually contains the same requests in the same order, <strong>even if some servers fail.</strong> Once commands are properly replicated, each server’s state machine processes them in log order, and the outputs are returned to clients. As a result, the servers appear to form a single, highly reliable state machine.</p>
<h2 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h2><p>Consensus algorithms for practical systems typically have the following properties:</p>
<ul>
<li>They ensure safety under all <em>non-Byzantine</em> conditions <strong>(never returning an incorrect result)</strong>, including network delays, partitions, and packet loss, duplication, and reordering.</li>
<li>They are fully functional (available) as long as any majority of the servers are operational and can communicate with each other and with clients.<ul>
<li>Thus, a typical cluster of 5 servers can tolerate the failure of any 2 servers.</li>
<li>Servers may later recover from state on stable storage and rejoin the cluster while they are assumed to fail by stopping.</li>
</ul>
</li>
<li>They do not depend on timing to ensure the consistency of the logs.<ul>
<li>Faulty clocks and extreme message delays can, at worst, cause availability problems.</li>
</ul>
</li>
<li>In the common case, a command can complete as soon as a majority of the cluster has responded to a single round of remote procedure calls. (A minority of slow servers need not impact overall system performance.)</li>
</ul>
<h1 id="What’s-wrong-with-Paxos"><a href="#What’s-wrong-with-Paxos" class="headerlink" title="What’s wrong with Paxos?"></a>What’s wrong with Paxos?</h1><p>Paxos ensures both safety and liveness, and it supports changes in cluster membership. Its correctness has been proven, and it is efficient in the normal case.</p>
<p>However, Paxos has two significant drawbacks:</p>
<h2 id="Paxos’-understanding-difficulty"><a href="#Paxos’-understanding-difficulty" class="headerlink" title="Paxos’ understanding difficulty"></a>Paxos’ understanding difficulty</h2><p>Paxos’ opaqueness derives from its choice of the <em>single-decree subset</em> as its foundation. It is divided into two stages that do not have simple intuitive explanations and cannot be understood independently, which makes it difficult to develop intuitions about why the single decree protocol works.</p>
<h2 id="Poor-for-building-practical-systems"><a href="#Poor-for-building-practical-systems" class="headerlink" title="Poor for building practical systems"></a>Poor for building practical systems</h2><p>Paxos does not provide a good foundation for building practical implementations. One reason is that there is no widely agreedupon algorithm for multi-Paxos since Lamport’s description only sketched possible approaches to mult-Paxos, nut many detail are missing.</p>
<p>Lamport’s description are mostly about single-decree Paxos, which also caused Paxos architecture became a poor one for building practical systems by the single-decree decomposition.</p>
<ol>
<li>Paxos choosing a collection of log entries <strong>independently</strong> and then melding them into a sequential log which just <strong>adds complexity</strong>. (It is simpler and more efficient to design a system <strong>around</strong> a log, where new entries are appended sequentially in a <strong>constrained order</strong>)</li>
<li>Paxos uses a symmetric p2p (peer-to-peer) approach at its core <em>(Although it suggests a weak form of leadership as a performance optimization)</em>. <strong>It would only makes sense in a simplified world where only one decision will be made</strong>. <em>(It is simpler and faster to <strong>first select a leader</strong></em>, then have the leader coordinate the decisions)*.</li>
</ol>
<p>As a result, <strong>practical systems bear little resemblance to Paxos.</strong> Each implementation begins with Paxos, but end with a significantly different architecture due to the difficulties in implementing Paxos. Paxos’ formulation may be a good one for proving theorems about its correctness, <strong>but real implementations are so different from Paxos that the proofs have little value.</strong> </p>
<blockquote>
<p>There are significant gaps between the description of the Paxos algorithm and the needs of a real-world system… the final system will be based on an unproven protocol. –Chubby inmplmenters</p>
</blockquote>
<p><em>A typical comment about the Paxos’ lack of practical systems implementation.</em></p>
<h1 id="Raft-Designing-for-understandability"><a href="#Raft-Designing-for-understandability" class="headerlink" title="Raft Designing for understandability"></a>Raft Designing for understandability</h1><p>There are several goals in designing Raft:</p>
<ol>
<li>It must provide a complete and practical foundation for system building.</li>
<li>It must be safe under all conditions and available under typical operating conditions.</li>
<li>It must be efficient for common operations.</li>
<li><strong>It must be possible for a large audience to understand the algorithm comfortably.</strong> (It should gives audience intuitions about algorithm, which make the extensions inevitable in real-world implementations)</li>
</ol>
<p>It used two techniques that makes analysis generally applicable.</p>
<h2 id="Problem-decomposition"><a href="#Problem-decomposition" class="headerlink" title="Problem decomposition"></a>Problem decomposition</h2><p>It divided problems into separate peces that could be solved, explained, and understood relatively independently.</p>
<p>Ex. Raft separated leader election, log replication, safety, and membership changes.</p>
<h2 id="Simplify-the-state-space"><a href="#Simplify-the-state-space" class="headerlink" title="Simplify the state space"></a>Simplify the state space</h2><p>It simplify the state space by reducing the number of states to consider, making the system more coherent and eliminating nondeterminism where possible.</p>
<p>In Raft, logs are not allowed to have holes and it limits the ways in which logs can become inconsistent with each other. Although in most cases our goal is to <strong>eliminate</strong> nondeterminism, there are some situations where <strong>nondeterminism actually improves understandability</strong>. (In particular, randomized approaches introduce nondeterminism since <strong>“It doesn’t matter which one to choice.”</strong>)</p>
<p>Ex. Raft use randomization to simplify the leader election algorithm.</p>
<h1 id="The-Raft-consensus-algorithm"><a href="#The-Raft-consensus-algorithm" class="headerlink" title="The Raft consensus algorithm"></a>The Raft consensus algorithm</h1><p>Raft is an algorithm for managing a replicated log of the form described in Section <em><a href="##replicated-state-machines">Replicated State Machine</a>.</em></p>
<h2 id="Summary-of-the-Raft"><a href="#Summary-of-the-Raft" class="headerlink" title="Summary of the Raft"></a>Summary of the Raft</h2><p>A condensed summary of the Raft consensus algorithm (excluding membership changes and log compaction) are shown below:</p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230427024056966.png" alt="Summary of the Raft"></p>
<p>The server behavior in the upper-left box is described as a set of rules that trigger independently and repeatedly. (Section numbers such as §5.2 is meanless for this notes) A formal <a target="_blank" rel="noopener" href="https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf">specification</a> describes the algorithm more precisely.</p>
<hr>
<p>Raft implements consensus by first electing a distinguished leader, then giving the leader complete responsibility for managing the replicated log. The leader accepts log entries from clients, replicates them on other servers, and tells servers when it is safe to apply log entries to their state machines which <strong>simplifies the management of the replicated log</strong>. A leader can fail or become disconnected from the other servers, in which case a new leader is elected.</p>
<p>Given the leader approach, Raft decomposes the consensus problem into three relatively independent subproblems:</p>
<ul>
<li>Leader election: a new leader must be chosen when an existing leader fails.</li>
<li>Log replication: the leader must accept log entries from clients and replicate them across the cluster, forcing the other logs to agree with its own.</li>
<li>Safety: the key safety propoerty for Raft is the State Machine Safety Property in Figure below. if any server has applied a particular log entry to its state machine, then no other server may apply a different command for the same log index.</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230427025032704.png" alt="Raft guarantees"></p>
<p>Raft guarantees that each of these properties shown above is <strong>true at all times.</strong> (Section numbers such as §5.2 is meanless for this notes) </p>
<h2 id="Raft-basics"><a href="#Raft-basics" class="headerlink" title="Raft basics"></a>Raft basics</h2><p>A Raft cluster contains several servers. At any given time each server is one of three states: <code>leader</code>, <code>follower</code>, or <code>candidate</code>. In normal operation there is <strong>exactly one <code>leader</code></strong> and all of the other servers are <strong><code>followers</code></strong>. </p>
<h3 id="Leader"><a href="#Leader" class="headerlink" title="Leader"></a>Leader</h3><p>The <code>leader</code> handles all client requests (if a client contacts a <code>follower</code>, the <code>follower</code> redirects it to the <code>leader</code>.)</p>
<h3 id="Follower"><a href="#Follower" class="headerlink" title="Follower"></a>Follower</h3><p><code>Followers</code> are passive, they issue no requests on their own but simply respond to requests from <code>leader</code> and <code>candidates</code>.</p>
<h3 id="Candidate"><a href="#Candidate" class="headerlink" title="Candidate"></a>Candidate</h3><p><code>Candidate</code> is used to elect a new leader as described above.</p>
<h3 id="Raft-Server-States"><a href="#Raft-Server-States" class="headerlink" title="Raft Server States"></a>Raft Server States</h3><p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230427190343271.png" alt="Raft Server States"></p>
<p>The figure above shows the states and their transitions. <code>Followers</code> only respond to requests from other servers. <strong>If a <code>follower</code> receives no communication, it becomes a <code>candidate</code> and initiates an election.</strong> A <code>candidate</code> that receives votes from a majority of the full cluster becomes the new <code>leader</code>. <code>Leaders</code> typically operate until they fail.</p>
<h3 id="Raft-Terms"><a href="#Raft-Terms" class="headerlink" title="Raft Terms"></a>Raft Terms</h3><p>Raft divides time into terms of arbitray length, as shown below:</p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230430201434582.png" alt="Raft Terms"></p>
<p>Terms are numbered with consecutive integers. Each term begins with an election, in which one or more candidates attempt to become leader. In some situations an election will result in a split vote, in this case the term will end with <strong>no leader</strong>, and a new term (with a new election) will begin shortly. <strong>Raft ensures that there is at most one leader in a given term.</strong></p>
<h3 id="Raft-communication"><a href="#Raft-communication" class="headerlink" title="Raft communication"></a>Raft communication</h3><p>Raft servers communicate using remote procedure calls (RPCs), and the basic consensus algorithm requires only two types of RPCs. (The third RPC has formed later)</p>
<ul>
<li><code>RequestVote RPCs</code>: They are initiated by <code>candidates</code> during elections.</li>
<li><code>AppendEntries RPCs</code>: They are initiated by <code>leaders</code> to replicate log entries and provide a form of heartbeat.</li>
<li><code>InstallSnapshot RPCs</code>: Used for transferring snapshots between servers.</li>
</ul>
<p>Servers retry RPCs if they do not receive a response in a timely manner, and they issue RPCs in parallel for best performance.</p>
<h2 id="Leader-election"><a href="#Leader-election" class="headerlink" title="Leader election"></a>Leader election</h2><p>Raft uses a heartbeat mechanism to trigger leader election. When servers start up, they begin as <code>followers</code>. A server remains in <code>follower</code> state as long as it receives valid RPCs from a <code>leader</code> or <code>candidate</code>.  Leaders send periodic heartbeats (<code>AppendEntries RPCs</code> that carry no log entries) to all <code>followers</code> in order to maintain their authority. <strong>If a <code>follower</code> receives no communication over a period of time called the election timeout, then it assumes there is no viable <code>leader</code> and begins an election to choose a new <code>leader</code>.</strong></p>
<p>To begin an election, a <code>follower</code> increments its current term (Ex. Term 3 ➡️ Term 4) and transitions to candidate state. It then votes for <strong>itself</strong> and issues <code>RequestVote RPCs</code> in parallel to each of the other servers in the cluster. A <code>candidate</code> continues in this state until meets one of three conditions :</p>
<ol>
<li>It wins the election</li>
<li>Another server wins election (establishs itself as <code>leader</code>)</li>
<li>A period of time goes by with no winner</li>
</ol>
<p><strong>Each sever vote one <code>candidate</code> in a given term with fcfs basis.</strong> A candidate wins an election if it receives votes from a majority of the servers in the full cluster for the same term. It then sends heartbeat messages to all of the other servers to establish its authority and prevent new elections.</p>
<p>While waiting for votes, a <code>candidate</code> may receive an <code>AppendEntries RPC</code> from another server claiming to be leader and will have two possible situations:</p>
<ul>
<li><strong>Accept</strong>: If <code>leader</code>‘s term (included in its RPC) is at <strong>least as large as</strong> the <code>candidate</code>‘s current term, then the <code>candidate</code> recognizes the <code>leader</code> as legitimate and <strong>returns to <code>follower</code> state</strong>.</li>
<li><strong>Decline</strong>: If the term in the RPC is <strong>smaller</strong> than the <code>candidate</code>’s current term, then the <code>candidate</code> <strong>rejects</strong> the RPC and <strong>continues in <code>candidate</code> state</strong>.</li>
</ul>
<h3 id="Split-votes"><a href="#Split-votes" class="headerlink" title="Split votes"></a>Split votes</h3><p>The third possible outcome is that a <code>candidate</code> <strong>neither wins nor loses the election</strong>. When this happens, each <code>candidate</code> will time out and <strong>start a new election by incrementing its term and initiating another round of <code>RequestVote RPCs</code></strong>. However, without extra measures split votes could repeat indefinitely.</p>
<p><strong>Raft uses randomized election timeouts to ensure that split votes are rare or being resolved quickly if happened.</strong> Election timeouts are chosen randomly from a fixed interval (e.g., 150-300ms), this spreads out the servers so that in most cases only a signle server will timeout. While a server (<code>candidate</code>) wins the election and sends heartbeats before any other servers time out.</p>
<h2 id="Log-replication"><a href="#Log-replication" class="headerlink" title="Log replication"></a>Log replication</h2><p>Once a <code>leader</code> has been elected, it begins serving client requests. Each client request contains a command to be executed by the replicated state machines. <strong>The <code>leader</code> appends the command to its log as a new entry, then issues <code>AppendEntries RPCs</code> in parallel to each of the other servers to replicate the entry.</strong> When the entry has been safely replicated (as described below), the <code>leader</code> applies the entry to its state machine and returns the result of that execution to the client. If <code>followers</code> crash or run slowly, or if network packets are lost, <strong>the leader retries <code>AppendEntries RPCs</code> indefinitely (even after it has responded to the client) until all <code>followers</code> eventually store all log entries.</strong></p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230501204548042.png" alt="Raft Logs"></p>
<p>Logs are organized as shown in figure above. Each log entry stores a state machine command along with the <code>term number</code> when the entry was received by the leader. The <code>term numbers</code> in log entries are used to detect inconsistencies between logs. Each log entry also has an integer index identifying its position in the log.</p>
<p>The leader decides when it is safe to apply a log entry (Called <code>committed</code>) to the state machines. Raft guarantees that <code>committed</code> entries are durable and will eventually be executed by all of the available state machines. A log entry is committed once the <code>leader</code> that created the entry has replicated it on a majority of the servers which also commits all preceding entries in the <code>leader</code>’s log, including entries created by previous leaders. The <code>leader</code> keeps track of the <strong>highest index</strong> it knows to be committed, and it includes that index in future <code>AppendEntries RPCs</code> (including heartbeats) so that the other servers eventually find out. Once a <code>follower</code> learns that a log entry is <code>committed</code>, it applies the entry to its local state machine (in log order).</p>
<p>In general, Raft maintains the following properties:</p>
<ul>
<li>If two entries in different logs have the same index and term, then they store the same command.</li>
<li>If two entries in different logs have the same index and term, then the logs are identical in all preceding entries.</li>
</ul>
<p><strong>The first property follows from the fact that a <code>leader</code> creates at most one entry with a given log index in a given term, and log entries never change their position in the log.</strong> The second property is guaranteed by a simple consistency check performed by <code>AppendEntries</code>. </p>
<h3 id="Consistency-check"><a href="#Consistency-check" class="headerlink" title="Consistency check"></a>Consistency check</h3><p>The consistency check acts as an induction step: the initial empty state of the logs satisfies the <code>Log Matching Property</code>, and the consistency check preserves the <code>Log Matching Property</code> whenever logs are extended. As a result, whenever <code>AppendEntries</code> returns successfully, the leader knows that the <code>follower</code>’s log is identical to its own log up through the new entries. During normal operation, the logs of the leader and followers stay consistent, so the <code>AppendEntries</code> consistency check never fails. <strong>However, <code>leader</code> crashes can leave the logs inconsistent (the old leader may not have fully replicated all of the entries in its log).</strong> These inconsistencies can compound over a series of <code>leader</code> and <code>follower</code> crashes.</p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230501224505489.png" alt="Different Logs"></p>
<p>The image above shows the wats in which <code>follower</code>‘s logs may differ from that of a new <code>leader</code>.  <strong>A <code>follower</code> may be missing entries that are present on the leader, it may have extra entries that are not present on the <code>leader</code>, or both. Missing and extraneous entries in a log may span multiple terms. (Ex. leader &amp; follower [f])</strong> Scenario (f) could occur if that server was the leader for <code>term 2</code>, added several entries to its log, then crashed before committing any of them; it restarted quickly, became leader for <code>term 3</code>, and added a few more entries to its log; before any of the entries in either <code>term 2</code> or <code>term 3</code> were committed, the server crashed again and remained down for several terms.</p>
<p>In Raft, the leader handles inconsistencies by forcing the followers’ logs to duplicate its own. <strong>This means that conflicting entries in follower logs will be overwritten with entries from the leader’s log.</strong> </p>
<p>To bring a <code>follower</code>’s log into consistency with its own, <strong>the leader must find the latest log entry where the two logs agree, delete any entries in the <code>follower</code>’s log after that point, and send the <code>follower</code> all of the <code>leader</code>’s entries after that point.</strong> All of these actions happen in response to the consistency check performed by <code>AppendEntries RPCs</code>.</p>
<img src= "/img/loading.gif" data-lazy-src="image/image-20230502164335587.png" alt="AppendEntries consistency check" style="zoom:50%;" />

<p>The <code>leader</code> maintains a <code>nextIndex</code> for each <code>follower</code>, which is the index of the next log entry the leader will send to that <code>follower</code>. <strong>When a <code>leader</code> first comes to power, it initializes all <code>nextIndex</code> values to the index just after the last one in its log (log index 11 in Figure above).</strong> <strong>If a <code>follower</code>’s log is inconsistent with the <code>leader</code>’s, the <code>AppendEntries consistency check</code> will fail in the next <code>AppendEntries RPC</code>. After a rejection, the <code>leader</code> decrements <code>nextIndex</code> and retries the <code>AppendEntries RPC</code>. Eventually <code>nextIndex</code> will reach a point where the <code>leader</code> and <code>follower</code> logs match.</strong> When this happens, <code>AppendEntries</code> will succeed, which removes any conflicting entries in the <code>follower</code>’s log and appends entries from the <code>leader</code>’s log (if any). Once <code>AppendEntries</code> succeeds, the <code>follower</code>’s log is consistent with the <code>leader</code>’s, and it will remain that way for the rest of the term.</p>
<h2 id="Safety"><a href="#Safety" class="headerlink" title="Safety"></a>Safety</h2><p>This section completes the Raft algorithm by adding a restriction on which servers may be elected leader. The restriction ensures that the <code>leader</code> for any given term contains all of the entries <code>committed</code> in previous terms. Given the election restriction, it make the rules for commitment more precise. Author also present a proof sketch for the <code>Leader Completeness Property</code> and show how it leads to correct behavior of the <code>replicated state machine</code>.</p>
<h3 id="Election-restriction"><a href="#Election-restriction" class="headerlink" title="Election restriction"></a>Election restriction</h3><p>In any leader-based consensus algorithm, the leader must eventually store all of the committed log entries. Unfortunately, this results in considerable additional mechanism and complexity. Raft uses a simpler approach where it guarantees that all the committed entries from previous terms are present on each new <code>leader</code> from the moment of its election, without the need to transfer those entries to the <code>leader</code>. This means that <strong>log entries only flow in one direction, from <code>leaders</code> to <code>followers</code>, and <code>leaders</code> never overwrite existing entries in their logs.</strong></p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230502170512933.png" alt="Time Sequence"></p>
<p>A time sequence showing why a leader cannot determine commitment using log entries from older terms. </p>
<ul>
<li>In time (a): S1 is leader and partially replicates the log entry at index 2.</li>
<li>In time (b): S1 crashes; S5 is elected leader for <code>term 3</code> with votes from S3, S4, and itself. </li>
<li>In time (c):  S5 crashes; S1 restarts and been elected as a leader, and continues replication.</li>
</ul>
<p>At this point, the log entry from <code>term 2</code> has been replicated on a majority of the servers, but it is not committed.</p>
<ul>
<li>In scenario (d): If S1 crashes again, S5 could be elected leader (with votes from S2, S3, and S4) and overwrite the entry with its own entry from <code>term 3</code>.</li>
</ul>
<p>However, if S1 replicates an entry from its current term on a majority of the servers before crashing, which generate the new scenario:</p>
<ul>
<li>In scenario (e): The entry <code>term 4</code> is committed, thus S5 cannot win a election (<code>term 3</code> &lt; <code>term 4</code>). At this point all preceding entries in the log are committed as well.</li>
</ul>
<p>Raft uses the voting process to prevent a <code>candidate</code> from winning an election unless its log contains all committed entries. A <code>candidate</code> must contact a majority of the cluster in order to be elected, which means that <strong>every committed entry must be present in at least one of those servers.</strong> If the <code>candidate</code>’s log is at least as up-to-date as any other log in that majority (where “up-to-date” is defined precisely below), then it will hold all the committed entries. The <code>RequestVote RPC</code> implements this restriction: <strong>the RPC includes information about the <code>candidate</code>’s log, and the voter denies its vote if its own log is more up-to-date than that of the candidate.</strong></p>
<h4 id="What-does-“up-to-date”-defined"><a href="#What-does-“up-to-date”-defined" class="headerlink" title="What does “up-to-date” defined?"></a>What does “up-to-date” defined?</h4><p>Raft determines which of two logs is more up-to-date by <strong>comparing the index and term of the last entries in the logs.</strong> If the logs have last entries with different terms, then the log with the later term is more up-to-date. <strong>If the logs end with the same term, then whichever log is longer is more up-to-date.</strong></p>
<h3 id="Committing-entries-from-previous-terms"><a href="#Committing-entries-from-previous-terms" class="headerlink" title="Committing entries from previous terms"></a>Committing entries from previous terms</h3><p>As what we talk on previous section, a <code>leader</code> know that an entry from its current term is committed once that entry is stored on a majority of the servers. If a <code>leader</code> crashes before committing an entry, future <code>leaders</code> will attempt to finish replicating the entry. However, a <code>leader</code> cannot immediately conclude that an entry from a previous term is committed once it is stored on a majority of servers. The figure in section <a href="####election-restriction">Election restriction</a> illustrates a situation where an old log entry is stored on a majority of servers, yet can still be overwritten by a future leader.</p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230502175016273.png" alt="Overlay Log"></p>
<p>If S1 (<code>leader</code> from <code>term T</code>) commits a new log entry from its term, and S5 is elected <code>leader</code> for a later <code>term U</code>, then there <strong>must be at least one server (S3) that accepted the log entry and also voted for S5.</strong></p>
<p>To eliminate problems like the one in Figure in section <a href="####election-restriction">Election restriction</a>, <strong>Raft never commits log entries from previous terms by counting replicas but only log entries from the leader’s current term are committed by counting replicas.</strong> Once an entry from the current term has been committed in this way, then all prior entries are committed indirectly because of the <code>Log Matching Property</code>. </p>
<p>Raft incurs this extra complexity in the commitment rules because <strong>log entries retain their original term numbers when a leader replicates entries from previous terms. In other consensus algorithms, if a new leader rereplicates entries from prior “terms,” it must do so with its new “term number.”</strong> Raft’s approach makes it easier to reason about log entries, since they maintain the same term number over time and across logs.</p>
<h2 id="Followeer-and-candidate-crashes"><a href="#Followeer-and-candidate-crashes" class="headerlink" title="Followeer and candidate crashes"></a>Followeer and candidate crashes</h2><p>Follower and candidate crashes are much simpler to handle than leader crashes, and they are both handled in the same way. If a <code>follower</code> or <code>candidate</code> crashes, then future <code>RequestVote</code> and <code>AppendEntries RPCs</code> sent to it will fail. Raft handles these failures by retrying indefinitely; if the crashed server restarts, then the RPC will complete successfully. If a server crashes after completing an RPC but before responding, then it will receive the same RPC again after it restarts.</p>
<h2 id="Timing-and-availability"><a href="#Timing-and-availability" class="headerlink" title="Timing and availability"></a>Timing and availability</h2><p>The ideal feature for Raft is that safety must not depend on timing: the system must not produce incorrect results just because some event happens more quickly or slowly than expected. However, availability (the ability of the system to respond to clients in a timely manner) must inevitably depend on timing.</p>
<p>Leader election is the aspect of Raft where timing is most critical. Raft will be able to elect and maintain a steady leader as long as the system satisfies the following timing requirement:</p>
<ul>
<li>broadcastTime &lt;&lt; electionTimeout &lt;&lt; MTBF (Mean Time Between Failures)[平均故障间隔]</li>
</ul>
<p>In this inequality <code>broadcastTime</code> is the average time it takes a server to send RPCs in parallel to every server in the cluster and receive their responses; <code>electionTimeout</code> is the election timeout described in Section <a href="###leader-election">Leader election</a>; and <code>MTBF</code> is the average time between failures for a single server. The broadcast time should be an order of magnitude less than the election timeout so that leaders can reliably send the heartbeat messages required to keep followers from starting elections; given the randomized approach used for election timeouts, this inequality also makes split votes unlikely. The election timeout should be a few orders of magnitude less than MTBF so that the system makes steady progress. When the leader crashes, the system will be unavailable for roughly the election timeout;</p>
<p>The <code>broadcast time</code> and <code>MTBF</code> are properties of the underlying system, while the <code>election timeout</code> is something we must choose. Raft’s RPCs typically require the recipient to persist information to stable storage, so the <code>broadcast time</code> may range from <code>0.5ms</code> to <code>20ms</code>, depending on storage technology. As a result, the <code>election timeout</code> is likely to be somewhere between <code>10ms</code> and <code>500ms</code>. Typical server <code>MTBFs</code> are several months or more, which easily satisfies the timing requirement.</p>
<h1 id="Cluster-membership-changes"><a href="#Cluster-membership-changes" class="headerlink" title="Cluster membership changes"></a>Cluster membership changes</h1><p>Up until now we have assumed that the cluster configuration (the set of servers participating in the consensus algorithm) is fixed. In practice, it will occasionally be necessary to change the configuration. Thus, a automatically configuration changes and incorporate them into the Raft consensus algorithm is needed.</p>
<p>For the configuration change mechanism to be safe, <strong>there must be no point during the transition where it is possible for two leaders to be elected for the same term.</strong> Unfortunately, any approach where servers switch directly from the old configuration to the new configuration is unsafe. I<strong>t isn’t possible to atomically switch all of the servers at once, so the cluster can potentially split into two independent majorities during the transition</strong> (see Figure below).</p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230503055011803.png" alt="Cluster Membership Changes"></p>
<p>Switching directly from one configuration to another is unsafe because different servers will switch at different times. In this example, the cluster grows from three servers to five (green means old, blue means new). Unfortunately, there is a point in time where two different leaders can be elected for the same term, one with a majority of the old configuration (C<sub>old</sub>) and another with a majority of the new configuration (C<sub>new</sub>). （在图例中出现问题的时刻，Server1可以通过自身以及Server2的投票拿到<strong>2&#x2F;3比例的选票？？</strong> 而赢得选举，成为领导者；并且此时Server5可以通过自身和Server3以及Server4的投票 <strong>拿到3&#x2F;5比例的选票？？</strong> 赢得选举，最终存在两个领导者。）</p>
<h2 id="The-joint-consensus"><a href="#The-joint-consensus" class="headerlink" title="The joint consensus"></a>The joint consensus</h2><p>In order to ensure safety, configuration changes must use a two-phase approach. In Raft the cluster first switches to a transitional configuration we call <code>joint consensus</code>; once the <code>joint consensus</code> has been committed, the system then transitions to the new configuration. <strong>The <code>joint consensus</code> combines both the old and new configurations:</strong></p>
<ul>
<li>Log entries are replicated to all servers in both configurations</li>
<li>Any server from either configuration may serve as <code>leader</code></li>
<li>Agreement (for elections and entry commitment) requires separate <strong>majorities from both the old and new configurations</strong></li>
</ul>
<p>The <code>joint consensus</code> allows individual servers to transition between configurations at different times without compromising safety. Furthermore, <code>joint consensus</code> allows the cluster to continue servicing client requests throughout the configuration change.</p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230503055750366.png" alt="Timeline For A Configuration Change"></p>
<p>The figure above is the timeline for a configuration change. Dashed lines (…) show configuration entries that have been created but not committed, and solid lines (__) show the latest committed configuration entry. The <code>leader</code> first creates the C<sub>old,new</sub> configuration entry in its log and commits it to C<sub>old,new</sub> (a majority of C<sub>old</sub> and a majority of C<sub>new</sub>). Then it creates the C<sub>new</sub> entry and commits it to a majority of C<sub>new</sub>. <strong>There is no point in time in which C<sub>old</sub> and C<sub>new</sub> can both make decisions independently.</strong></p>
<p>When the <code>leader</code> receives a request to change the configuration from C<sub>old</sub> to C<sub>new</sub>, it stores the configuration for <code>joint consensus</code> (C<sub>old,new</sub> in the figure) as a log entry and replicates that entry using the mechanisms described previously. **Once a given server adds the new configuration entry to its log, it uses that configuration for all future decisions (a server always uses the latest configuration in its log, regardless of whether the entry is committed). **This means that the <code>leader</code> will use the rules of C<sub>old,new</sub> to determine when the log entry for C<sub>old,new</sub> is committed. If the <code>leader</code> crashes, a new <code>leader</code> may be chosen under either C<sub>old</sub> or C<sub>old,new</sub> depending on whether the winning <code>candidate</code> has received C<sub>old,new</sub>. <strong>In any case, C<sub>new</sub> cannot make unilateral decisions during this period.</strong></p>
<p>Once C<sub>old,new</sub> has been committed, neither C<sub>old</sub> nor C<sub>new</sub> can make decisions without approval of the other, and <strong>the <code>Leader Completeness Property</code> ensures that only servers with the C<sub>old,new</sub> log entry can be elected as <code>leader</code>.</strong> It is now safe for the <code>leader</code> to create a log entry describing C<sub>new</sub> and replicate it to the cluster. Again, this configuration will take effect on each server as soon as it is seen. <strong>When the new configuration has been committed under the rules of C<sub>new</sub> the old configuration is irrelevant and servers not in the new configuration can be shut down.</strong> As shown in Figure above, there is no time when C<sub>old</sub> and C<sub>new</sub> can both make unilateral decisions; this guarantees safety.</p>
<h2 id="Issues-to-address-for-reconfiguration"><a href="#Issues-to-address-for-reconfiguration" class="headerlink" title="Issues to address for reconfiguration"></a>Issues to address for reconfiguration</h2><p>There are three more issues to address for reconfiguration:</p>
<ol>
<li>New servers may not initially store any log entries</li>
</ol>
<p><strong>If they are added to the cluster in this state, it could take quite a while for them to catch up, during which time it might not be possible to commit new log entries.</strong> In order to avoid availability gaps, Raft introduces an additional phase before the configuration change, in which the new servers join the cluster as <code>non-voting members</code> (the leader replicates log entries to them, but they are not considered for majorities). Once the new servers have caught up with the rest of the cluster, the reconfiguration can proceed as described above.</p>
<ol start="2">
<li>The cluster leader may not be part of the new configuration</li>
</ol>
<p>In this case, the <code>leader</code> steps down (returns to <code>follower</code> state) once it has committed the C<sub>new</sub> log entry. **This means that there will be a period of time (while it is committing C<sub>new</sub>) when the <code>leader</code> is managing a cluster that does not include itself; it replicates log entries but does not count itself in majorities. **The leader transition occurs when C<sub>new</sub> is committed because this is the first point when the new configuration can operate independently (it will always be possible to choose a leader from C<sub>new</sub>). Before this point, it may be the case that only a server from C<sub>old</sub> can be elected <code>leader</code>.</p>
<ol start="3">
<li>Removed servers (those not in C<sub>new</sub>) can disrupt the cluster</li>
</ol>
<p>These servers will not receive heartbeats, so they will time out and start new elections. They will then send <code>RequestVote RPCs</code> with new term numbers, and this will cause the current <code>leader</code> to revert to <code>follower</code> state. A new <code>leader</code> will eventually be elected, but the removed servers will time out again and the process will repeat, resulting in poor availability.</p>
<p>To prevent this problem, **servers disregard <code>RequestVote RPCs</code> when they believe a current <code>leader</code> exists. **Specifically, **if a server receives a <code>RequestVote RPC</code> within the minimum election timeout of hearing from a current <code>leader</code>, it does not update its term or grant its vote. **This does not affect normal elections, where each server <strong>waits at least a minimum election timeout before starting an election</strong>. However, it helps avoid disruptions from removed servers: if a <code>leader</code> is able to get heartbeats to its cluster, then it will not be deposed by larger term numbers.</p>
<h1 id="Log-compaction"><a href="#Log-compaction" class="headerlink" title="Log compaction"></a>Log compaction</h1><p>Raft’s log grows during normal operation to incorporate more client requests, but in a practical system, it cannot grow without bound. As the log grows longer, it occupies more space and takes more time to replay. This will eventually cause availability problems without some mechanism to discard obsolete information that has accumulated in the log.</p>
<p><strong>Snapshotting is the simplest approach to compaction.</strong> In snapshotting, the entire current system state is written to a <em>snapshot</em> on stable storage, then the entire log up to that point is discarded.</p>
<h2 id="Incremental-approaches-to-compaction"><a href="#Incremental-approaches-to-compaction" class="headerlink" title="Incremental approaches to compaction"></a>Incremental approaches to compaction</h2><p>These operate on a fraction of the data at once, so they spread the load of compaction more evenly over time. They first select a region of data that has accumulated many deleted and overwritten objects, then they rewrite the live objects from that region more compactly and free the region. This requires significant additional mechanism and complexity compared to snapshotting, which simplifies the problem by always operating on the entire data set. While log cleaning would require modifications to Raft, state machines can implement LSM trees using the same interface as snapshotting.</p>
<h2 id="Snapshots"><a href="#Snapshots" class="headerlink" title="Snapshots"></a>Snapshots</h2><p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230503074226861.png" alt="Log Compression"></p>
<p><em>Figure description: A server replaces the committed entries in its log (indexes 1 through 5) with a new snapshot, which stores just the current state (variables x and y in this example). The snapshot’s <code>last included index</code> and <code>term</code> serve to position the snapshot in the log preceding entry 6.</em></p>
<p>The figure above shows the basic idea of snapshotting in Raft. Each server takes <code>snapshots</code> independently, covering just the committed entries in its log. Most of the work consists of the state machine writing its current state to the <code>snapshot</code>. Raft also includes a small amount of metadata in the snapshot: </p>
<ul>
<li><code>last included index</code>: It is the index of the last entry in the log that the snapshot replaces (the last entry the state machine had applied)</li>
<li><code>last included term</code>: it is the term of the entry describe above</li>
</ul>
<p>These are preserved to support the <code>AppendEntries consistency check</code> for the first log entry following the <em>snapshot</em>, since that entry needs a previous log index and term. To enable cluster membership changes (Last Section), the <em>snapshot</em> also includes the latest configuration in the log as of <code>last included index</code>. Once a server completes writing a <em>snapshot</em>, it may delete all log entries up through the <code>last included index</code>, as well as any prior <em>snapshot</em>.</p>
<p>Although servers normally take <em>snapshots</em> independently, the <code>leader</code> must occasionally send <em>snapshots</em> to <code>followers</code> that lag behind. This happens when the <code>leader</code> has already discarded the next log entry that it needs to send to a <code>follower</code>. Fortunately, this situation is unlikely in normal operation: a <code>follower</code> that has kept up with the <code>leader</code> would already have this entry. <strong>However, an exceptionally slow <code>follower</code> or a new server joining the cluster (as descript in Section <a href="##cluster-membership-changes">Cluster membership changes</a>) would not. The way to bring such a follower up-to-date is for the leader to send it a <em>snapshot</em> over the network.</strong></p>
<p><img src= "/img/loading.gif" data-lazy-src="/en/Raft/image/image-20230503090641802.png" alt="A summary of the InstallSnapshot RPC"></p>
<p>The figure above is a summary of the <code>InstallSnapshot RPC</code>. <em>Snapshots</em> are split into chunks for transmission; this gives the <code>follower</code> a sign of life with each chunk, so it can reset its election timer.</p>
<p>The <code>leader</code> uses a new RPC called <code>InstallSnapshot</code> to send <em>snapshots</em> to <code>followers</code> that are too far behind. <strong>When a <code>follower</code> receives a <em>snapshot</em> with this RPC, it must decide what to do with its existing log entries. <strong>Usually the <em>snapshot</em> will contain new information not already in the recipient’s log. I</strong>n this case, the <code>follower</code> discards its entire log</strong> (it is all superseded by the snapshot and may possibly have uncommitted entries that conflict with the snapshot). If instead the <code>follower</code> receives a snapshot that describes a prefix of its log (due to retransmission or by mistake), then <strong>log entries covered by the <em>snapshot</em> are deleted but entries following the <em>snapshot</em> are still valid and must be retained.</strong></p>
<h2 id="Issues-that-impact-snapshotting-performance"><a href="#Issues-that-impact-snapshotting-performance" class="headerlink" title="Issues that impact snapshotting performance"></a>Issues that impact snapshotting performance</h2><p>There are two more issues that impact snapshotting performance. </p>
<ol>
<li>Servers must decide when to <em>snapshot</em></li>
</ol>
<p>If a server <em>snapshots</em> too often, it wastes disk bandwidth and energy; if it <em>snapshots</em> too infrequently, it risks exhausting its storage capacity, and it increases the time required to replay the log during restarts. <strong>One simple strategy is to take a <em>snapshot</em> when the log reaches a fixed size in bytes.</strong> If this size is set to be significantly larger than the expected size of a <em>snapshot</em>, then the disk bandwidth overhead for snapshotting will be small.</p>
<ol start="2">
<li>Writing a snapshot can take a significant amount of time</li>
</ol>
<p>The solution is to use Cow (copy-on-write) techniques so that new updates can be accepted without impacting the <em>snapshot</em> being written. For example, state machines built with functional data structures naturally support this. Alternatively, the operating system’s copy-on-write support (e.g., fork on Linux) can be used to create an in-memory <em>snapshot</em> of the entire state machine (our implementation uses this approach).</p>
<h1 id="Client-interaction"><a href="#Client-interaction" class="headerlink" title="Client interaction"></a>Client interaction</h1><p>This section describes how clients interact with Raft, including how clients find the cluster leader and how Raft supports linearizable semantics (线性化语义).</p>
<p>Clients of Raft send all of their requests to the <code>leader</code>. When a client first starts up, it connects to a randomly chosen server. <strong>If the client’s first choice is not the <code>leader</code>, that server will reject the client’s request and supply information about the most recent <code>leader</code> it has heard from (<code>AppendEntries</code> requests include the network address of the <code>leader</code>).</strong> If the <code>leader</code> crashes, client requests will time out; clients then try again with randomly-chosen servers.</p>
<h2 id="Linearizable-semantics"><a href="#Linearizable-semantics" class="headerlink" title="Linearizable semantics"></a>Linearizable semantics</h2><p>The goal for Raft is to implement linearizable semantics (each operation appears to execute instantaneously, exactly once, at some point between its invocation and its response). However, as described so far Raft can execute a command multiple times: for example, if the <code>leader</code> crashes after committing the log entry but before responding to the client, the client will retry the command with a new <code>leader</code>, causing it to be executed a second time.</p>
<p>The solution is for clients to assign <strong>unique serial numbers</strong> to every command. Then, the state machine tracks the latest serial number processed for each client, along with the associated response. <strong>If it receives a command whose serial number has already been executed, it responds immediately without re-executing the request.</strong></p>
<h3 id="Precautions-for-returning-stale-data"><a href="#Precautions-for-returning-stale-data" class="headerlink" title="Precautions for returning stale data"></a>Precautions for returning stale data</h3><p>Read-only operations can be handled without writing anything into the log. However, with no additional measures, this would run the risk of returning stale data, since the <code>leader </code>responding to the request might have been superseded by a newer <code>leader</code> of which it is unaware. Linearizable reads must not return stale data, and Raft needs two extra precautions to guarantee this without using the log.</p>
<ol>
<li>A <code>leader</code> must have the latest information on which entries are committed</li>
</ol>
<p>The <code>Leader Completeness Property</code> guarantees that a <code>leader</code> has all committed entries, but <strong>at the start of its term, it may not know which those are.</strong> To find out, it needs to commit an entry from its term. <strong>Raft handles this by having each <code>leader</code> commit a blank no-op entry into the log at the start of its term.</strong></p>
<ol start="2">
<li>A <code>leader</code> must check whether it has been deposed before processing a read-only request (its information may be stale if a more recent leader has been elected).</li>
</ol>
<p>Raft handles this by having the <code>leader</code> exchange heartbeat messages with a majority of the cluster before responding to read-only requests. Alternatively, the <code>leader</code> could rely on the heartbeat mechanism to provide a form of lease, but this would rely on timing for safety (it assumes bounded clock skew).</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://blog.tianzhe.me">Tyson Hu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://blog.tianzhe.me/en/Raft/">https://blog.tianzhe.me/en/Raft/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Algorithm/">Algorithm</a><a class="post-meta__tags" href="/tags/C/">C++</a></div><div class="post_share"><div class="social-share" data-image="https://raft.github.io/logo/solo.svg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/en/firebase-admin_setup/" title="Firebase AdminSDK Setup"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://i.ytimg.com/vi/fgT6r4f9Apc/maxresdefault.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">Firebase AdminSDK Setup</div></div></a></div><div class="next-post pull-right"><a href="/cn/algo-intro/" title="Leetcode 刷题前言"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">Leetcode 刷题前言</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/en/142-LinkedListCycle-II/" title="Problem 142: Linked List Cycle II"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-30</div><div class="title">Problem 142: Linked List Cycle II</div></div></a></div><div><a href="/en/1-TwoSum/" title="Problem 1: Two Sum"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-03</div><div class="title">Problem 1: Two Sum</div></div></a></div><div><a href="/en/160-IntersectionOfTwoLinkedLists/" title="Problem 160: Intersection Of Two Linked Lists"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-30</div><div class="title">Problem 160: Intersection Of Two Linked Lists</div></div></a></div><div><a href="/en/19-RemoveNthNodeFromEndOfList/" title="Problem 19: Remove Nth Node From End of List"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-29</div><div class="title">Problem 19: Remove Nth Node From End of List</div></div></a></div><div><a href="/en/202-HappyNumber/" title="Problem 202: Happy Number"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-03</div><div class="title">Problem 202: Happy Number</div></div></a></div><div><a href="/en/203-RemoveLinkedListElements/" title="Problem 203: Remove Linked List Elements"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-28</div><div class="title">Problem 203: Remove Linked List Elements</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Valine</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="https://avatars1.githubusercontent.com/u/62329498?s=400&amp;u=20198ec972904a758bc5f6ba4888c5ac6b6270fb&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Tyson Hu</div><div class="author-info__description">总结，记录，提升</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">34</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Tyson-Hu"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Tyson-Hu" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2535280450&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="https://discordapp.com/users/652523903830327307" target="_blank" title="Discord"><i class="fab fa-discord"></i></a><a class="social-icon" href="https://www.linkedin.com/in/tianzhe-hu-151bb0256/" target="_blank" title="Linkedin"><i class="fab fa-linkedin"></i></a><a class="social-icon" href="mailto:me@tianzhe.me" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">评论首选Twikoo，如果无法使用或者延迟过高可尝试Valine。邮箱处填写QQ邮箱即可获取QQ头像。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Intro"><span class="toc-number">1.</span> <span class="toc-text">Intro</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replicated-state-machines"><span class="toc-number">2.</span> <span class="toc-text">Replicated state machines</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-does-it-be-replicated"><span class="toc-number">2.1.</span> <span class="toc-text">How does it be replicated?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Properties"><span class="toc-number">2.2.</span> <span class="toc-text">Properties</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#What%E2%80%99s-wrong-with-Paxos"><span class="toc-number">3.</span> <span class="toc-text">What’s wrong with Paxos?</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Paxos%E2%80%99-understanding-difficulty"><span class="toc-number">3.1.</span> <span class="toc-text">Paxos’ understanding difficulty</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Poor-for-building-practical-systems"><span class="toc-number">3.2.</span> <span class="toc-text">Poor for building practical systems</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Raft-Designing-for-understandability"><span class="toc-number">4.</span> <span class="toc-text">Raft Designing for understandability</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem-decomposition"><span class="toc-number">4.1.</span> <span class="toc-text">Problem decomposition</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Simplify-the-state-space"><span class="toc-number">4.2.</span> <span class="toc-text">Simplify the state space</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-Raft-consensus-algorithm"><span class="toc-number">5.</span> <span class="toc-text">The Raft consensus algorithm</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Summary-of-the-Raft"><span class="toc-number">5.1.</span> <span class="toc-text">Summary of the Raft</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raft-basics"><span class="toc-number">5.2.</span> <span class="toc-text">Raft basics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Leader"><span class="toc-number">5.2.1.</span> <span class="toc-text">Leader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Follower"><span class="toc-number">5.2.2.</span> <span class="toc-text">Follower</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Candidate"><span class="toc-number">5.2.3.</span> <span class="toc-text">Candidate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Raft-Server-States"><span class="toc-number">5.2.4.</span> <span class="toc-text">Raft Server States</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Raft-Terms"><span class="toc-number">5.2.5.</span> <span class="toc-text">Raft Terms</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Raft-communication"><span class="toc-number">5.2.6.</span> <span class="toc-text">Raft communication</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Leader-election"><span class="toc-number">5.3.</span> <span class="toc-text">Leader election</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Split-votes"><span class="toc-number">5.3.1.</span> <span class="toc-text">Split votes</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Log-replication"><span class="toc-number">5.4.</span> <span class="toc-text">Log replication</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Consistency-check"><span class="toc-number">5.4.1.</span> <span class="toc-text">Consistency check</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Safety"><span class="toc-number">5.5.</span> <span class="toc-text">Safety</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Election-restriction"><span class="toc-number">5.5.1.</span> <span class="toc-text">Election restriction</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#What-does-%E2%80%9Cup-to-date%E2%80%9D-defined"><span class="toc-number">5.5.1.1.</span> <span class="toc-text">What does “up-to-date” defined?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Committing-entries-from-previous-terms"><span class="toc-number">5.5.2.</span> <span class="toc-text">Committing entries from previous terms</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Followeer-and-candidate-crashes"><span class="toc-number">5.6.</span> <span class="toc-text">Followeer and candidate crashes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Timing-and-availability"><span class="toc-number">5.7.</span> <span class="toc-text">Timing and availability</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Cluster-membership-changes"><span class="toc-number">6.</span> <span class="toc-text">Cluster membership changes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-joint-consensus"><span class="toc-number">6.1.</span> <span class="toc-text">The joint consensus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Issues-to-address-for-reconfiguration"><span class="toc-number">6.2.</span> <span class="toc-text">Issues to address for reconfiguration</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Log-compaction"><span class="toc-number">7.</span> <span class="toc-text">Log compaction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Incremental-approaches-to-compaction"><span class="toc-number">7.1.</span> <span class="toc-text">Incremental approaches to compaction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Snapshots"><span class="toc-number">7.2.</span> <span class="toc-text">Snapshots</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Issues-that-impact-snapshotting-performance"><span class="toc-number">7.3.</span> <span class="toc-text">Issues that impact snapshotting performance</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Client-interaction"><span class="toc-number">8.</span> <span class="toc-text">Client interaction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linearizable-semantics"><span class="toc-number">8.1.</span> <span class="toc-text">Linearizable semantics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Precautions-for-returning-stale-data"><span class="toc-number">8.1.1.</span> <span class="toc-text">Precautions for returning stale data</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/en/1-TwoSum/" title="Problem 1: Two Sum"><img src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Problem 1: Two Sum"/></a><div class="content"><a class="title" href="/en/1-TwoSum/" title="Problem 1: Two Sum">Problem 1: Two Sum</a><time datetime="2024-05-04T02:38:00.000Z" title="Created 2024-05-03 22:38:00">2024-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/202-HappyNumber/" title="Problem 202: Happy Number"><img src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Problem 202: Happy Number"/></a><div class="content"><a class="title" href="/en/202-HappyNumber/" title="Problem 202: Happy Number">Problem 202: Happy Number</a><time datetime="2024-05-04T01:53:00.000Z" title="Created 2024-05-03 21:53:00">2024-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/242-ValidAnagram/" title="Problem 242: Valid Anagram"><img src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Problem 242: Valid Anagram"/></a><div class="content"><a class="title" href="/en/242-ValidAnagram/" title="Problem 242: Valid Anagram">Problem 242: Valid Anagram</a><time datetime="2024-05-04T01:29:00.000Z" title="Created 2024-05-03 21:29:00">2024-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/349-IntersectionOfTwoArrays/" title="Problem 349: Intersection of Two Arrays"><img src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Problem 349: Intersection of Two Arrays"/></a><div class="content"><a class="title" href="/en/349-IntersectionOfTwoArrays/" title="Problem 349: Intersection of Two Arrays">Problem 349: Intersection of Two Arrays</a><time datetime="2024-05-04T01:29:00.000Z" title="Created 2024-05-03 21:29:00">2024-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/142-LinkedListCycle-II/" title="Problem 142: Linked List Cycle II"><img src= "/img/loading.gif" data-lazy-src="https://repository-images.githubusercontent.com/408927712/1c5ce46e-266f-43f0-b543-75bf341239b5" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Problem 142: Linked List Cycle II"/></a><div class="content"><a class="title" href="/en/142-LinkedListCycle-II/" title="Problem 142: Linked List Cycle II">Problem 142: Linked List Cycle II</a><time datetime="2024-04-30T16:20:00.000Z" title="Created 2024-04-30 12:20:00">2024-04-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Tyson Hu</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">无限进步</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="Chat"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://blog-twikoo-ten.vercel.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://blog-twikoo-ten.vercel.app',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))

    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(init)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'xHCgzmchP05ijopdHb7G7Rwk-MdYXbMMI',
      appKey: 'WddDXWYJFaSRootb65gpWAFl',
      avatar: 'monsterid',
      serverURLs: 'https://xhcgzmch.api.lncldglobal.com',
      emojiMaps: {"2020":"https://i0.hdslb.com/bfs/emote/dc709fac0d361370bcf0d36d32adb97df7c95824.png","2021":"https://i0.hdslb.com/bfs/emote/14d8996128d46dabd3a2ed6c172c8af918d7a5d2.png","2022":"https://i0.hdslb.com/bfs/emote/a783df2ce72952c44004007462324bde4b092a0c.png","总冠军":"https://i0.hdslb.com/bfs/emote/4edd5c6290a1b6c98c478177f4fffe69539639eb.png","高考加油":"https://i0.hdslb.com/bfs/emote/a795e57db00a3f08eb4e6d76842593789ef8e33f.png","微笑":"https://i0.hdslb.com/bfs/emote/685612eadc33f6bc233776c6241813385844f182.png","微笑-春节":"https://i0.hdslb.com/bfs/emote/f32e5d367c81fbb88b54d7fe46366de04fe4f38f.png","微笑-愚人节":"https://i0.hdslb.com/bfs/emote/774d19d2416eb5b30ac66b02ac580b1b0ca92a80.png","微笑-愚人节2":"https://i0.hdslb.com/bfs/emote/ff45294fbd469ed51eab492e15b8bc7f8e755f14.png","口罩":"https://i0.hdslb.com/bfs/emote/3ad2f66b151496d2a5fb0a8ea75f32265d778dd3.png","doge":"https://i0.hdslb.com/bfs/emote/3087d273a78ccaff4bb1e9972e2ba2a7583c9f11.png","doge-春节":"https://i0.hdslb.com/bfs/emote/feb9abf68df628803ff69a244e744470c2b7e136.png","doge-圣诞":"https://i0.hdslb.com/bfs/emote/1afb5eb96846e0876071eeecb47be95dbf55f08d.png","doge-愚人节":"https://i0.hdslb.com/bfs/emote/8ab62b33061d20bc27beec798a2f73c639e8bb6e.png","doge-愚人节2":"https://i0.hdslb.com/bfs/emote/94460b4e92163c4ca88684b1830ca182d56ddea7.png","妙啊":"https://i0.hdslb.com/bfs/emote/b4cb77159d58614a9b787b91b1cd22a81f383535.png","妙啊-春节":"https://i0.hdslb.com/bfs/emote/692f196da6a623a1634ea305618d37709c2c87f0.png","妙啊-圣诞":"https://i0.hdslb.com/bfs/emote/1cdb10e4b6c6743a1ec96f1579e3ef3045a8f225.png","妙啊-愚人节":"https://i0.hdslb.com/bfs/emote/5675a5d2f3e7fb6b29db0ca8c7703237a18c4271.png","妙啊-愚人节2":"https://i0.hdslb.com/bfs/emote/7b55232e0733afe509d4ac6282d7e604f6f2064f.png","OK":"https://i0.hdslb.com/bfs/emote/4683fd9ffc925fa6423110979d7dcac5eda297f4.png","OK-春节":"https://i0.hdslb.com/bfs/emote/ad17fceba45996104c8b8e2e3f4efd7e2f588368.png","OK-圣诞":"https://i0.hdslb.com/bfs/emote/75d1c99cce001d6d103a8fd406616be9f51621ab.png","OK-愚人节":"https://i0.hdslb.com/bfs/emote/76cc9da7f4a054cb02aad900f0ca3d3fda9c9667.png","OK-愚人节2":"https://i0.hdslb.com/bfs/emote/4ab30d0c384aa7fb112d6078777d46f73797869b.png","星星眼":"https://i0.hdslb.com/bfs/emote/63c9d1a31c0da745b61cdb35e0ecb28635675db2.png","星星眼-春节":"https://i0.hdslb.com/bfs/emote/f6f01068ac7f6548779b0e16daa61974f9299b17.png","星星眼-圣诞":"https://i0.hdslb.com/bfs/emote/195641c30c55f34f9cd82c5e5c32d66a425c7723.png","星星眼-愚人节":"https://i0.hdslb.com/bfs/emote/270e85c95c1ad919848b415601ed3a879bd08127.png","星星眼-愚人节2":"https://i0.hdslb.com/bfs/emote/99471a235923d29c00fa9fc46b82e74196f99722.png","辣眼睛":"https://i0.hdslb.com/bfs/emote/35d62c496d1e4ea9e091243fa812866f5fecc101.png","辣眼睛-春节":"https://i0.hdslb.com/bfs/emote/1ad7c9d351bd64332cc8520c165ee0b32a6e82fa.png","辣眼睛-圣诞":"https://i0.hdslb.com/bfs/emote/8080adfe5acdfd0b6b09bd91db24ea7334ac7b44.png","辣眼睛-愚人节":"https://i0.hdslb.com/bfs/emote/65ed9509df4d509a1cdf22e75a6d3b708f4e9afb.png","辣眼睛-愚人节2":"https://i0.hdslb.com/bfs/emote/60fcc72634bc1d2ad612a18b46256d5d50804ca2.png","吃瓜":"https://i0.hdslb.com/bfs/emote/4191ce3c44c2b3df8fd97c33f85d3ab15f4f3c84.png","吃瓜-春节":"https://i0.hdslb.com/bfs/emote/fbd58fe2465d84d32f37800af0fe6f25711ef397.png","吃瓜-圣诞":"https://i0.hdslb.com/bfs/emote/aa6a3022e47b441c7f84d02cacc063a728a561e0.png","吃瓜-愚人节":"https://i0.hdslb.com/bfs/emote/f05344578512ef18878de01d188657fbf81d31c8.png","吃瓜-愚人节2":"https://i0.hdslb.com/bfs/emote/39a3f88f2232bdd8b8116d952060c72fcf093b55.png","滑稽":"https://i0.hdslb.com/bfs/emote/d15121545a99ac46774f1f4465b895fe2d1411c3.png","滑稽-春节":"https://i0.hdslb.com/bfs/emote/e56b466b43dd6930756d5caf4c22bef4f963dd35.png","滑稽-圣诞":"https://i0.hdslb.com/bfs/emote/5874276ea716d0e9797f827dcfca4332acf8f0de.png","滑稽-愚人节":"https://i0.hdslb.com/bfs/emote/e8c1b263949c2617e6395b190d185b2f8cdf0747.png","滑稽-愚人节2":"https://i0.hdslb.com/bfs/emote/1d44d848b82fe0fcbd4d6f23e3c4a26a0fe4f40f.png","呲牙":"https://i0.hdslb.com/bfs/emote/b5a5898491944a4268360f2e7a84623149672eb6.png","呲牙-春节":"https://i0.hdslb.com/bfs/emote/6ae3b1008d2fee7e15b5eb447b2ccff18e664b88.png","呲牙-圣诞":"https://i0.hdslb.com/bfs/emote/ae4395c1e29e9a2db0c9ccc4c0db05c414816e68.png","呲牙-愚人节":"https://i0.hdslb.com/bfs/emote/299e5867bb79f42d8553023909f42e89707cb500.png","呲牙-愚人节2":"https://i0.hdslb.com/bfs/emote/3688061f6a90c8559dc4663f4d4971ea27d0c014.png","打call":"https://i0.hdslb.com/bfs/emote/431432c43da3ee5aab5b0e4f8931953e649e9975.png","打call-春节":"https://i0.hdslb.com/bfs/emote/bf990016e43b7111cab4566dea194ba837a1a88f.png","打call-圣诞":"https://i0.hdslb.com/bfs/emote/2b04dd2d0e55d978ee485e1f7f3c5e355493ab78.png","打call-愚人节":"https://i0.hdslb.com/bfs/emote/49240d8643d7702519fc4cc468e0003a7623c0e3.png","打call-愚人节2":"https://i0.hdslb.com/bfs/emote/7ffaa98f9f49489022815e38dbcb1a04677a8f13.png","歪嘴":"https://i0.hdslb.com/bfs/emote/4384050fbab0586259acdd170b510fe262f08a17.png","歪嘴-愚人节":"https://i0.hdslb.com/bfs/emote/6cc4c091d3f2cc540f64d8f10ffe516fd2f4ea2b.png","歪嘴-愚人节2":"https://i0.hdslb.com/bfs/emote/f24a5cd8e8400a3ab850ce68ac495fde66a03b64.png","调皮":"https://i0.hdslb.com/bfs/emote/8290b7308325e3179d2154327c85640af1528617.png","调皮-愚人节":"https://i0.hdslb.com/bfs/emote/a09481ceb0644f799d94805446fd52dce775b022.png","调皮-愚人节2":"https://i0.hdslb.com/bfs/emote/0da0b2049a4f7b310e3992afbcb7367b81707824.png","虎年":"https://i0.hdslb.com/bfs/emote/a062f5fa2bafe677e49b6963a2bbb11dd4fe1e11.png","牛年":"https://i0.hdslb.com/bfs/emote/9275275ff1f2659310648221107d20bc4970f106.png","老鼠":"https://i0.hdslb.com/bfs/emote/8e6fb491eb1bb0d5862e7ec8ccf9a3da12b6c155.png","豹富":"https://i0.hdslb.com/bfs/emote/3d1dbe52ea16e12ff7b1c371196f728a4097fb33.png","嗑瓜子":"https://i0.hdslb.com/bfs/emote/28a91da1685d90124cfeead74622e1ebb417c0eb.png","嗑瓜子-春节":"https://i0.hdslb.com/bfs/emote/d2f9910f2d6e52ead3bf1ee29754cd1176f5fc2e.png","笑哭":"https://i0.hdslb.com/bfs/emote/c3043ba94babf824dea03ce500d0e73763bf4f40.png","捂脸-圣诞":"https://i0.hdslb.com/bfs/emote/9af59557383770c398daac81583e6c4d27d83da7.png","笑哭-春节":"https://i0.hdslb.com/bfs/emote/29ce59fb7f14351d195609ef297d30e336bdb240.png","藏狐":"https://i0.hdslb.com/bfs/emote/ba0937ef6f3ccca85e2e0047e6263f3b4da37201.png","脸红":"https://i0.hdslb.com/bfs/emote/0922c375da40e6b69002bd89b858572f424dcfca.png","脸红-旧":"https://i0.hdslb.com/bfs/emote/50cb2606c285614f5786bd387c4f00dff923c82b.png","脱单doge":"https://i0.hdslb.com/bfs/emote/bf7e00ecab02171f8461ee8cf439c73db9797748.png","给心心":"https://i0.hdslb.com/bfs/emote/1597302b98827463f5b75c7cac1f29ea6ce572c4.png","嘟嘟":"https://i0.hdslb.com/bfs/emote/abd7404537d8162720ccbba9e0a8cdf75547e07a.png","哦呼":"https://i0.hdslb.com/bfs/emote/362bded07ea5434886271d23fa25f5d85d8af06c.png","喜欢":"https://i0.hdslb.com/bfs/emote/8a10a4d73a89f665feff3d46ca56e83dc68f9eb8.png","酸了":"https://i0.hdslb.com/bfs/emote/92b1c8cbceea3ae0e8e32253ea414783e8ba7806.png","嫌弃":"https://i0.hdslb.com/bfs/emote/de4c0783aaa60ec03de0a2b90858927bfad7154b.png","大哭":"https://i0.hdslb.com/bfs/emote/2caafee2e5db4db72104650d87810cc2c123fc86.png","害羞":"https://i0.hdslb.com/bfs/emote/9d2ec4e1fbd6cb1b4d12d2bbbdd124ccb83ddfda.png","疑惑":"https://i0.hdslb.com/bfs/emote/b7840db4b1f9f4726b7cb23c0972720c1698d661.png","喜极而泣":"https://i0.hdslb.com/bfs/emote/485a7e0c01c2d70707daae53bee4a9e2e31ef1ed.png","奸笑":"https://i0.hdslb.com/bfs/emote/bb84906573472f0a84cebad1e9000eb6164a6f5a.png","笑":"https://i0.hdslb.com/bfs/emote/81edf17314cea3b48674312b4364df44d5c01f17.png","偷笑":"https://i0.hdslb.com/bfs/emote/6c49d226e76c42cd8002abc47b3112bc5a92f66a.png","惊讶":"https://i0.hdslb.com/bfs/emote/f8e9a59cad52ae1a19622805696a35f0a0d853f3.png","捂脸":"https://i0.hdslb.com/bfs/emote/6921bb43f0c634870b92f4a8ad41dada94a5296d.png","阴险":"https://i0.hdslb.com/bfs/emote/ba8d5f8e7d136d59aab52c40fd3b8a43419eb03c.png","囧":"https://i0.hdslb.com/bfs/emote/12e41d357a9807cc80ef1e1ed258127fcc791424.png","呆":"https://i0.hdslb.com/bfs/emote/33ad6000d9f9f168a0976bc60937786f239e5d8c.png","抠鼻":"https://i0.hdslb.com/bfs/emote/cb89184c97e3f6d50acfd7961c313ce50360d70f.png","大笑":"https://i0.hdslb.com/bfs/emote/ca94ad1c7e6dac895eb5b33b7836b634c614d1c0.png","惊喜":"https://i0.hdslb.com/bfs/emote/0afecaf3a3499479af946f29749e1a6c285b6f65.png","无语":"https://i0.hdslb.com/bfs/emote/44667b7d9349957e903b1b62cb91fb9b13720f04.png","点赞":"https://i0.hdslb.com/bfs/emote/1a67265993913f4c35d15a6028a30724e83e7d35.png","鼓掌":"https://i0.hdslb.com/bfs/emote/895d1fc616b4b6c830cf96012880818c0e1de00d.png","尴尬":"https://i0.hdslb.com/bfs/emote/cb321684ed5ce6eacdc2699092ab8fe7679e4fda.png","灵魂出窍":"https://i0.hdslb.com/bfs/emote/43d3db7d97343c01b47e22cfabeca84b4251f35a.png","委屈":"https://i0.hdslb.com/bfs/emote/d2f26cbdd6c96960320af03f5514c5b524990840.png","傲娇":"https://i0.hdslb.com/bfs/emote/010540d0f61220a0db4922e4a679a1d8eca94f4e.png","疼":"https://i0.hdslb.com/bfs/emote/905fd9a99ec316e353b9bd4ecd49a5f0a301eabf.png","冷":"https://i0.hdslb.com/bfs/emote/cb0ebbd0668640f07ebfc0e03f7a18a8cd00b4ed.png","生病":"https://i0.hdslb.com/bfs/emote/0f25ce04ae1d7baf98650986454c634f6612cb76.png","吓":"https://i0.hdslb.com/bfs/emote/9c10c5ebc7bef27ec641b8a1877674e0c65fea5d.png","吐":"https://i0.hdslb.com/bfs/emote/06946bfe71ac48a6078a0b662181bb5cad09decc.png","捂眼":"https://i0.hdslb.com/bfs/emote/c5c6d6982e1e53e478daae554b239f2b227b172b.png","嘘声":"https://i0.hdslb.com/bfs/emote/e64af664d20716e090f10411496998095f62f844.png","思考":"https://i0.hdslb.com/bfs/emote/cfa9b7e89e4bfe04bbcd34ccb1b0df37f4fa905c.png","再见":"https://i0.hdslb.com/bfs/emote/fc510306bae26c9aec7e287cdf201ded27b065b9.png","翻白眼":"https://i0.hdslb.com/bfs/emote/eba54707c7168925b18f6f8b1f48d532fe08c2b1.png","哈欠":"https://i0.hdslb.com/bfs/emote/888d877729cbec444ddbd1cf4c9af155a7a06086.png","奋斗":"https://i0.hdslb.com/bfs/emote/bb2060c15dba7d3fd731c35079d1617f1afe3376.png","墨镜":"https://i0.hdslb.com/bfs/emote/3a03aebfc06339d86a68c2d893303b46f4b85771.png","难过":"https://i0.hdslb.com/bfs/emote/a651db36701610aa70a781fa98c07c9789b11543.png","撇嘴":"https://i0.hdslb.com/bfs/emote/531863568e5668c5ac181d395508a0eeb1f0cda4.png","抓狂":"https://i0.hdslb.com/bfs/emote/4c87afff88c22439c45b79e9d2035d21d5622eba.png","生气":"https://i0.hdslb.com/bfs/emote/3195714219c4b582a4fb02033dd1519913d0246d.png","2021万圣节":"https://i0.hdslb.com/bfs/emote/0277ee5af7de1bdfc6a935b1e44b72e9ffd5ba62.png","月饼":"https://i0.hdslb.com/bfs/emote/89b19c5730e08d6f12fadf6996de5bc2e52f81fe.png","加油武汉":"https://i0.hdslb.com/bfs/emote/eb966aaa5b690d3f9308a9f936f5b5a72a7f956b.png","画风突变":"https://i0.hdslb.com/bfs/emote/ba4de7a3f97644038b15195bdc9f82a8fd118e77.png","福":"https://i0.hdslb.com/bfs/emote/802429a301ac5b35a0480d9526a070ce67cd8097.png","蜡烛":"https://i0.hdslb.com/bfs/emote/1f5b25a8608046fef703620425cea9c9dc4b2206.png","tv-白眼":"https://i0.hdslb.com/bfs/emote/c1d59f439e379ee50eef488bcb5e5378e5044ea4.png","tv-doge":"https://i0.hdslb.com/bfs/emote/6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv-坏笑":"https://i0.hdslb.com/bfs/emote/1f0b87f731a671079842116e0991c91c2c88645a.png","tv-难过":"https://i0.hdslb.com/bfs/emote/87f46748d3f142ebc6586ff58860d0e2fc8263ba.png","tv-生气":"https://i0.hdslb.com/bfs/emote/26702dcafdab5e8225b43ffd23c94ac1ff932654.png","tv-委屈":"https://i0.hdslb.com/bfs/emote/d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv-斜眼笑":"https://i0.hdslb.com/bfs/emote/911f987aa8bc1bee12d52aafe62bc41ef4474e6c.png","tv-呆":"https://i0.hdslb.com/bfs/emote/fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv-发怒":"https://i0.hdslb.com/bfs/emote/34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv-惊吓":"https://i0.hdslb.com/bfs/emote/0d15c7e2ee58e935adc6a7193ee042388adc22af.png","tv-呕吐":"https://i0.hdslb.com/bfs/emote/9f996894a39e282ccf5e66856af49483f81870f3.png","tv-思考":"https://i0.hdslb.com/bfs/emote/90cf159733e558137ed20aa04d09964436f618a1.png","tv-微笑":"https://i0.hdslb.com/bfs/emote/70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv-疑问":"https://i0.hdslb.com/bfs/emote/0793d949b18d7be716078349c202c15ff166f314.png","tv-大哭":"https://i0.hdslb.com/bfs/emote/23269aeb35f99daee28dda129676f6e9ea87934f.png","tv-鼓掌":"https://i0.hdslb.com/bfs/emote/1d21793f96ef4e6f48b23e53e3b9e42da833a0f6.png","tv-抠鼻":"https://i0.hdslb.com/bfs/emote/c666f55e88d471e51bbd9fab9bb308110824a6eb.png","tv-亲亲":"https://i0.hdslb.com/bfs/emote/a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv-调皮":"https://i0.hdslb.com/bfs/emote/b9c41de8e82dd7a8515ae5e3cb63e898bf245186.png","tv-笑哭":"https://i0.hdslb.com/bfs/emote/1abc628f6d4f4caf9d0e7800878f4697abbc8273.png","tv-晕":"https://i0.hdslb.com/bfs/emote/5443c22b4d07fb1907ccc610c8e6db254f2461b7.png","tv-点赞":"https://i0.hdslb.com/bfs/emote/f85c354995bd99e28fc76c869bfe42ba6438eff4.png","tv-害羞":"https://i0.hdslb.com/bfs/emote/a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv-睡着":"https://i0.hdslb.com/bfs/emote/8b196675b53af58264f383c50ad0945048290b33.png","tv-色":"https://i0.hdslb.com/bfs/emote/61822c7e9aae5da76475e7892534545336b23a6f.png","tv-吐血":"https://i0.hdslb.com/bfs/emote/09dd16a7aa59b77baa1155d47484409624470c77.png","tv-无奈":"https://i0.hdslb.com/bfs/emote/ea8ed89ee9878f2fece2dda0ea8a5dbfe21b5751.png","tv-再见":"https://i0.hdslb.com/bfs/emote/180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv-流汗":"https://i0.hdslb.com/bfs/emote/cead1c351ab8d79e9f369605beb90148db0fbed3.png","tv-偷笑":"https://i0.hdslb.com/bfs/emote/bb690d4107620f1c15cff29509db529a73aee261.png","tv-抓狂":"https://i0.hdslb.com/bfs/emote/fe31c08edad661d63762b04e17b8d5ae3c71a757.png","tv-黑人问号":"https://i0.hdslb.com/bfs/emote/45821a01f51bc867da9edbaa2e070410819a95b2.png","tv-困":"https://i0.hdslb.com/bfs/emote/241ee304e44c0af029adceb294399391e4737ef2.png","tv-打脸":"https://i0.hdslb.com/bfs/emote/56ab10b624063e966bfcb76ea5dc4794d87dfd47.png","tv-闭嘴":"https://i0.hdslb.com/bfs/emote/c9e990da7f6e93975e25fd8b70e2e290aa4086ef.png","tv-鄙视":"https://i0.hdslb.com/bfs/emote/6e72339f346a692a495b123174b49e4e8e781303.png","tv-腼腆":"https://i0.hdslb.com/bfs/emote/89712c0d4af73e67f89e35cbc518420380a7f6f4.png","tv-馋":"https://i0.hdslb.com/bfs/emote/fc7e829b845c43c623c8b490ee3602b7f0e76a31.png","tv-可爱":"https://i0.hdslb.com/bfs/emote/9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv-发财":"https://i0.hdslb.com/bfs/emote/34db290afd2963723c6eb3c4560667db7253a21a.png","tv-生病":"https://i0.hdslb.com/bfs/emote/8b0ec90e6b86771092a498c54f09fc94621c1900.png","tv-流鼻血":"https://i0.hdslb.com/bfs/emote/c32d39db2737f89b904ca32700d140a9241b0767.png","tv-尴尬":"https://i0.hdslb.com/bfs/emote/7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv-大佬":"https://i0.hdslb.com/bfs/emote/093c1e2c490161aca397afc45573c877cdead616.png","tv-流泪":"https://i0.hdslb.com/bfs/emote/7e71cde7858f0cd50d74b0264aa26db612a8a167.png","tv-冷漠":"https://i0.hdslb.com/bfs/emote/b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv-皱眉":"https://i0.hdslb.com/bfs/emote/72ccad6679fea0d14cce648b4d818e09b8ffea2d.png","tv-鬼脸":"https://i0.hdslb.com/bfs/emote/0ffbbddf8a94d124ca2f54b360bbc04feb6bbfea.png","tv-调侃":"https://i0.hdslb.com/bfs/emote/4bc022533ef31544ca0d72c12c808cf4a1cce3e3.png","tv-目瞪口呆":"https://i0.hdslb.com/bfs/emote/0b8cb81a68de5d5365212c99375e7ace3e7891b7.png","tvgif-白眼":"https://i0.hdslb.com/bfs/emote/48f75163437445665a9be80bb316e4cb252c5415.gif","tvgif-doge":"https://i0.hdslb.com/bfs/emote/302d6c88c63ed162c81a49cafe7ed2709e6fb955.gif","tvgif-坏笑":"https://i0.hdslb.com/bfs/emote/5d2572efd09aab5dde9e2a198bb3f9ac1e2a982e.gif","tvgif-难过":"https://i0.hdslb.com/bfs/emote/9c6b41008a67755410f712334c64313df5f91b3f.gif","tvgif-生气":"https://i0.hdslb.com/bfs/emote/1902a5a2df5b5c931d88c12f0feb264b1e109d0d.gif","tvgif-委屈":"https://i0.hdslb.com/bfs/emote/af5a5853edb43a8178a8cb5df707fa5e88143699.gif","tvgif-斜眼笑":"https://i0.hdslb.com/bfs/emote/c66568b471192ca1f62f6ed4384dc1b283ab7508.gif","tvgif-呆":"https://i0.hdslb.com/bfs/emote/d3fa91e4db9215eb1e20ab9da44f1214aa4bda7b.gif","tvgif-发怒":"https://i0.hdslb.com/bfs/emote/3959eb81b952e4fa8d269d98f9e3639172d84073.gif","tvgif-惊吓":"https://i0.hdslb.com/bfs/emote/13549060757fcd92b11d0657d9b3b6038f97abb6.gif","tvgif-呕吐":"https://i0.hdslb.com/bfs/emote/db58e9442aae26694af18cc1683607cca3a16763.gif","tvgif-思考":"https://i0.hdslb.com/bfs/emote/b63f9146bfd985af014f8d6d4bdb498805be48f9.gif","tvgif-微笑":"https://i0.hdslb.com/bfs/emote/b98656855d782f61cb8edc7f7fca6563ecafff7e.gif","tvgif-疑问":"https://i0.hdslb.com/bfs/emote/fce1b1a0f3b0e39a2dc16a18508dba7b91e929f4.gif","tvgif-大哭":"https://i0.hdslb.com/bfs/emote/cba61f05f3039b02a7ffc0dfcd9d7995df9fdd74.gif","tvgif-鼓掌":"https://i0.hdslb.com/bfs/emote/be106e6b265883a9f28fbe10f7b765701e2618d4.gif","tvgif-抠鼻":"https://i0.hdslb.com/bfs/emote/696d9f93e722144dc2a78aeffc569418fdf3d565.gif","tvgif-亲亲":"https://i0.hdslb.com/bfs/emote/3534ea44ab74bd20352b88c245a06c4b4c46d271.gif","tvgif-调皮":"https://i0.hdslb.com/bfs/emote/fcd967395fd14e4dd5829fa7e8a967ce23205e52.gif","tvgif-笑哭":"https://i0.hdslb.com/bfs/emote/1c2fd1e8c9dde12812f86e5d4cbddd8993d98082.gif","tvgif-晕":"https://i0.hdslb.com/bfs/emote/030040ec5c9ddc9e3d067658c4139e7314ab42f8.gif","tvgif-点赞":"https://i0.hdslb.com/bfs/emote/30ecff401245fb56bcc1cf588d1809ac1ab1607c.gif","tvgif-害羞":"https://i0.hdslb.com/bfs/emote/411a3e459e8580f5bfd9f639a408247c4b509935.gif","tvgif-睡着":"https://i0.hdslb.com/bfs/emote/3c8b5e293261287a6203597e29b3de07df4d18c6.gif","tvgif-色":"https://i0.hdslb.com/bfs/emote/a0c6d99ab0ab63b8648f5283ff72cec04b604828.gif","tvgif-吐血":"https://i0.hdslb.com/bfs/emote/e17e4539e169d14a3389ff147afea760cebe5de5.gif","tvgif-无奈":"https://i0.hdslb.com/bfs/emote/eb4cb5f07cfd177c7e6a7914316717e56d9cc1d0.gif","tvgif-再见":"https://i0.hdslb.com/bfs/emote/344f61609ecce2008520dc8a977b6169215748a9.gif","tvgif-流汗":"https://i0.hdslb.com/bfs/emote/390bccec65eaff536bd5bb2a0c5b8b0bdea47334.gif","tvgif-偷笑":"https://i0.hdslb.com/bfs/emote/7f11e6f7f63e79112b833bd41fa13a83d7cd8474.gif","tvgif-抓狂":"https://i0.hdslb.com/bfs/emote/a476b93ecd8e94ac3257323fd822f91cef212de2.gif","tvgif-黑人问号":"https://i0.hdslb.com/bfs/emote/b609adf664be33224a9923262031165ae3e34cd2.gif","tvgif-困":"https://i0.hdslb.com/bfs/emote/91c2bf34ecf842d7016c01d841db3d4074bd281f.gif","tvgif-打脸":"https://i0.hdslb.com/bfs/emote/b0fad4856e59c1240e448437da3287bb5ce547e5.gif","tvgif-闭嘴":"https://i0.hdslb.com/bfs/emote/a3fc5388b09e945be3f18fe23bfed5874a0285b7.gif","tvgif-鄙视":"https://i0.hdslb.com/bfs/emote/293b5d459e6264ecf314d20937a936fa672ccd1e.gif","tvgif-腼腆":"https://i0.hdslb.com/bfs/emote/30984e8264324f901d19bea85dada7103b695534.gif","tvgif-馋":"https://i0.hdslb.com/bfs/emote/2525c5703c594e5f0752f68db8948773caebde47.gif","tvgif-可爱":"https://i0.hdslb.com/bfs/emote/f92d20f76258bc5f33fc9d7c5e2a1d41fef19a7c.gif","tvgif-发财":"https://i0.hdslb.com/bfs/emote/76131e52c9b033681b4c896c6024d29ef7ec7ec2.gif","tvgif-生病":"https://i0.hdslb.com/bfs/emote/beb94829fe04f1a41bd6ca611e1f6ca9ca169afa.gif","tvgif-流鼻血":"https://i0.hdslb.com/bfs/emote/8ef473f74a849420da712487b2f56ecca1f695f5.gif","tvgif-尴尬":"https://i0.hdslb.com/bfs/emote/e0b84ef5ee3e5b8978e584c7c5a6550c51d15f84.gif","tvgif-大佬":"https://i0.hdslb.com/bfs/emote/14ca0c05382b8741940942b2430b7a8d55c02f7e.gif","酷仔":"https://i0.hdslb.com/bfs/emote/390100ada4659b4516984d386499fb22c0025084.png","赞了":"https://i0.hdslb.com/bfs/emote/40ded585bbd6328fc390076b5de224fd38b46793.png","暗中观察":"https://i0.hdslb.com/bfs/emote/80a752e0718db211e4135b4ba821813f4c151e2c.png","么么哒":"https://i0.hdslb.com/bfs/emote/2f418440776e88605ddc426eac898202c1f5fa4d.png","哭哭":"https://i0.hdslb.com/bfs/emote/cbf36e518f1d50618f6d054aa69993ecc339fe8f.png","饿了":"https://i0.hdslb.com/bfs/emote/ff91ea94adf7c5b04db305c18d17b444f7360059.png","问号":"https://i0.hdslb.com/bfs/emote/a905b58b32016a1f0ff7d9193b62749f0d491707.png","嘿嘿":"https://i0.hdslb.com/bfs/emote/8a15a45e228179f912ce11dbd5478f6ad54e9854.png","卖萌":"https://i0.hdslb.com/bfs/emote/a0d37b43d1e786ba811d9b0ae590c479dcce6c44.png","喵":"https://i0.hdslb.com/bfs/emote/eb46e78c9d86ccbe9842f0235c7cb4f4e0e80a57.png","小电视-笑":"https://i0.hdslb.com/bfs/emote/f80d384875183dfe2e24be13011c595c0210d273.png","小电视-发愁":"https://i0.hdslb.com/bfs/emote/05e279abbf3f72d5cc45548504a4220c5514b8b9.png","小电视-赞":"https://i0.hdslb.com/bfs/emote/86ccf6d0b5480169bf80f3582fae09d7ed455c06.png","小电视-差评":"https://i0.hdslb.com/bfs/emote/38456e3bde2839b00b536a8be13934fa57c8e298.png","小电视-嘟嘴":"https://i0.hdslb.com/bfs/emote/6fd437f547ef1e4f231ff475d02f58bb94cef5a5.png","小电视-汗":"https://i0.hdslb.com/bfs/emote/5c150cec77eae1b05d5ca46526450ff3beeb44d2.png","小电视-害羞":"https://i0.hdslb.com/bfs/emote/de3aee88f7b6cc20ba9480c96c02f83a844381a9.png","小电视-吃惊":"https://i0.hdslb.com/bfs/emote/05188008ea84c70d94e0076e28de15bf56f4c441.png","小电视-哭泣":"https://i0.hdslb.com/bfs/emote/938bdf98df945576ae88e2a22931db07ded9e663.png","小电视-太太喜欢":"https://i0.hdslb.com/bfs/emote/eb41a8c04840e4f77e76a4bff7a29ac89c432f4e.png","小电视-好怒啊":"https://i0.hdslb.com/bfs/emote/68d524b7e515396b6563d320fb710c64abfb1063.png","小电视-困惑":"https://i0.hdslb.com/bfs/emote/6853161f0eab3332b874ab7c6c0311035b7538f3.png","小电视-我好兴奋":"https://i0.hdslb.com/bfs/emote/a695fe1301aab2675ab6f6e34757c25a863a8617.png","小电视-思索":"https://i0.hdslb.com/bfs/emote/f8219e484d5a55787c3f1722dc3112d0eba03a69.png","小电视-无语":"https://i0.hdslb.com/bfs/emote/fbd12affebfdaadd3d721bffdb685a6b1ee71219.png","2233娘-大笑":"https://i0.hdslb.com/bfs/emote/16b8794be990cefa6caeba4d901b934a227ee3b8.png","2233娘-吃惊":"https://i0.hdslb.com/bfs/emote/d1628c43d35b1530c0504a643ff80b6189fa0a43.png","2233娘-大哭":"https://i0.hdslb.com/bfs/emote/476a2a60f6e337b8c0697a592e0aa82781f6b33b.png","2233娘-耶":"https://i0.hdslb.com/bfs/emote/d7178e258a0efc969b65ccc2b1322fb235f5dff4.png","2233娘-卖萌":"https://i0.hdslb.com/bfs/emote/ea893aa25355de95ab4f03c2dad3f0c58d0c159e.png","2233娘-疑问":"https://i0.hdslb.com/bfs/emote/0b41f509351958dbb63d472fec0132d1bd03bd14.png","2233娘-汗":"https://i0.hdslb.com/bfs/emote/247cd9df8cdf84b18368c21e3b2dd374e84c0927.png","2233娘-困惑":"https://i0.hdslb.com/bfs/emote/714eeb4eae0d0933b4ff08b7df788b1982f6b940.png","2233娘-怒":"https://i0.hdslb.com/bfs/emote/f31953119c51b9748016440ac0b632f779929b37.png","2233娘-委屈":"https://i0.hdslb.com/bfs/emote/d9d0bf9d358af8d5761093ec66d4e3f60d963a63.png","2233娘-郁闷":"https://i0.hdslb.com/bfs/emote/485203fe7100f2c8fc40b2800a18fe20b35f2f1a.png","2233娘-第一":"https://i0.hdslb.com/bfs/emote/3754ee6e5985bd0bd7dfb668981f2a8733398ebd.png","2233娘-喝水":"https://i0.hdslb.com/bfs/emote/695bf5429472049b52c1e0de586f8a2511195a23.png","2233娘-吐魂":"https://i0.hdslb.com/bfs/emote/e999af499edf38a91ca68b1a9d2f97042c1d6734.png","2233娘-无言":"https://i0.hdslb.com/bfs/emote/fdb5870f32cfaf7949e0f88a13f6feba4a48b719.png","蛆音娘-卖萌":"https://i0.hdslb.com/bfs/emote/4cd1024d0c2ecee93224477946656d32c1705ccf.png","蛆音娘-吃瓜群众":"https://i0.hdslb.com/bfs/emote/5d0d6cc54b508d30b4f50b6b5f7b7e1e259d84ea.png","蛆音娘-吃惊":"https://i0.hdslb.com/bfs/emote/7a4cb0b644214d476ce198ddf6a7a0aa31311199.png","蛆音娘-害怕":"https://i0.hdslb.com/bfs/emote/7407634bf67bfe9d7806f15d57608a1b18c2b4c2.png","蛆音娘-扶额":"https://i0.hdslb.com/bfs/emote/a4d8f95baaa24821fd591a7dbeee1b869e760f59.png","蛆音娘-滑稽":"https://i0.hdslb.com/bfs/emote/d3717f10ffe9787336bc39a09214270988521a67.png","蛆音娘-哼":"https://i0.hdslb.com/bfs/emote/8854f1b8a82126e3b87f3a1563da5feb55b23e71.png","蛆音娘-机智":"https://i0.hdslb.com/bfs/emote/e543c0a823ca915df9362283f4ae950e9e9cc2e9.png","蛆音娘-哭泣":"https://i0.hdslb.com/bfs/emote/a23055546c19eba663b16370b8e072394d87ff53.png","蛆音娘-睡觉觉":"https://i0.hdslb.com/bfs/emote/40ef7e6d931acb37e5514b70d13663e86dc3698b.png","蛆音娘-生气":"https://i0.hdslb.com/bfs/emote/bf398cbbcfaae107d1b59aaf03895f38422e3d87.png","蛆音娘-偷看":"https://i0.hdslb.com/bfs/emote/52463ded4f23649db10ba3ced662ed946c5edf0b.png","蛆音娘-吐血":"https://i0.hdslb.com/bfs/emote/5772d22015e5b2b40a9fe302b5967ec7282ac848.png","蛆音娘-无语":"https://i0.hdslb.com/bfs/emote/b6c763c6484ce2e48299ceb21861e46318868871.png","蛆音娘-摇头":"https://i0.hdslb.com/bfs/emote/b7278f750c6f2235f41f37056d727f25d3bf781f.png","蛆音娘-疑问":"https://i0.hdslb.com/bfs/emote/7750b698d15a1b8e83c0f59106e8e9cd5cb57897.png","蛆音娘-die":"https://i0.hdslb.com/bfs/emote/52543025a070fde5c01a10320c9636ec3173ac99.png","蛆音娘-OK":"https://i0.hdslb.com/bfs/emote/52a0dcee66c91bf123bf53bd48a269b1317d17f9.png","蛆音娘-肥皂":"https://i0.hdslb.com/bfs/emote/7f1a857e9430dcf3050ce0ef5fa19aefebea6dc4.png","蛆音娘-大笑":"https://i0.hdslb.com/bfs/emote/1d3355fb89c24ab3c50e5c152d8b990a290dc63e.png","芮小凸小凹-嗯？":"https://i0.hdslb.com/bfs/emote/f3c72e045ebd2487a381f50291be15b053767a80.png","芮小凸小凹-超棒":"https://i0.hdslb.com/bfs/emote/987947c1bdac0bc10b684f28baaec78176023b83.png","芮小凸小凹-哎":"https://i0.hdslb.com/bfs/emote/38bcf3a53b34551e5efa0cd0ee84fc7faa477a49.png","芮小凸小凹-666":"https://i0.hdslb.com/bfs/emote/3e505cef421024a650b971c1f2db7f8ef1ad1840.png","芮小凸小凹-哼":"https://i0.hdslb.com/bfs/emote/92e4a9d422f1604f2b1b3ea3f6057636273db56e.png","芮小凸小凹-怀疑":"https://i0.hdslb.com/bfs/emote/587f22aa1cfaa4b2d91928998e023be29d8c3975.png","芮小凸小凹-发现":"https://i0.hdslb.com/bfs/emote/147b6ba27d5cbb90d155f34c41cb45f1f00b6007.png","芮小凸小凹-绝望":"https://i0.hdslb.com/bfs/emote/22ad072a785604f3bd8c1aae4ea1ceb1e4694cec.png","芮小凸小凹-可爱":"https://i0.hdslb.com/bfs/emote/8bddb47b5877fd79e937aafeb7f4d69f58a8b6e4.png","芮小凸小凹-警告":"https://i0.hdslb.com/bfs/emote/54607206c814409a99fac65fb3b780c6bbd1e60d.png","芮小凸小凹-呵呵":"https://i0.hdslb.com/bfs/emote/811aa3ba5809a8d5936f988f953e5af7fd7c5351.png","芮小凸小凹-膜拜":"https://i0.hdslb.com/bfs/emote/038c86c0e616f7ead667c6f7af32e54feac32965.png","芮小凸小凹-哭":"https://i0.hdslb.com/bfs/emote/000c0dddd08950133740487a57873b389a3af457.png","芮小凸小凹-无聊":"https://i0.hdslb.com/bfs/emote/62527ee5c4e80aad9b42069778c91f905c90d986.png","芮小凸小凹-围观":"https://i0.hdslb.com/bfs/emote/c9b4fe6161f4a3cc884a5b03e9674c8a58ee228f.png","芮小凸小凹-失落":"https://i0.hdslb.com/bfs/emote/813f98c0632587286c6e809a49eda15a2edfa447.png","芮小凸小凹-是吗":"https://i0.hdslb.com/bfs/emote/05b7153fb606e526ce8d102febd25889828ce425.png","芮小凸小凹-心动":"https://i0.hdslb.com/bfs/emote/24afe39fbf8755a28673bdf51bdf8ce72bc62d51.png","芮小凸小凹-喜欢":"https://i0.hdslb.com/bfs/emote/b389e30a3c7924ca2b59a5333412b8d92cad07df.png","芮小凸小凹-嘻嘻":"https://i0.hdslb.com/bfs/emote/b7a4a07a7c24f5fa23a99ca6749708fadfedf765.png","芮小凸小凹-震撼":"https://i0.hdslb.com/bfs/emote/79c8b68509a9d316618d61aedaae93097669dae6.png","芮小凸小凹-有见解":"https://i0.hdslb.com/bfs/emote/7f842228b9a2c36851cecab0527fca55a1f01b58.png","芮小凸小凹-震惊":"https://i0.hdslb.com/bfs/emote/be4b48350b817af496bdccba2ab85c77b711cec3.png","芮小凸小凹-心痛":"https://i0.hdslb.com/bfs/emote/b2217e8b81f122949f3960d99c08ac72eac5923b.png","工作细胞-搬砖":"https://i0.hdslb.com/bfs/emote/3058ff55e1c8ed84af46a5851785aaedd75b9457.png","工作细胞-别担心":"https://i0.hdslb.com/bfs/emote/06f0827e45ba2d8ead9617dc93f6ac5fecf43054.png","工作细胞-别怂":"https://i0.hdslb.com/bfs/emote/fbbb9574837d64012c2f26f9faf18504fe860ba2.png","工作细胞-冲鸭":"https://i0.hdslb.com/bfs/emote/29beaae54921b9cd99d7d7cf82a8b51d647e329e.png","工作细胞-戳戳":"https://i0.hdslb.com/bfs/emote/b4bef418e0737dfb336bb85c9a032bd6731b1024.png","工作细胞-打扰了":"https://i0.hdslb.com/bfs/emote/17b60cb5ed56b5c3bcc6ee374e86ce3884e04a8a.png","工作细胞-核弹开关":"https://i0.hdslb.com/bfs/emote/8bb6903caf1498dee5b362749da2261853449f9b.png","工作细胞-加油":"https://i0.hdslb.com/bfs/emote/c4f09e4cde7cb8b8f2a831750f2aef9b4ab8144d.png","工作细胞-交给我":"https://i0.hdslb.com/bfs/emote/ae585bc6e0fe41f12fa7812d36f35587fdd459c2.png","工作细胞-惊吓":"https://i0.hdslb.com/bfs/emote/1c28e19390090fd4ea70186fde4064c409c27537.png","工作细胞-霉菌再见":"https://i0.hdslb.com/bfs/emote/8d34f746dd6af644ea529b256c6f94602a1dc49f.png","工作细胞-迷路":"https://i0.hdslb.com/bfs/emote/ea04896151334d7210a7117e21de24f80dcff773.png","工作细胞-努力工作":"https://i0.hdslb.com/bfs/emote/77e3b4f8811e13c68480051a01e29393f4f35457.png","工作细胞-前方施工":"https://i0.hdslb.com/bfs/emote/b443b8daf8d12df26a8e4f92a63028e4da584bcf.png","工作细胞-闪亮登场":"https://i0.hdslb.com/bfs/emote/a1eb51316498efe0d50419c05c2f73d681ea08e7.png","工作细胞-社死":"https://i0.hdslb.com/bfs/emote/d41ef6665f1227580be60343ac6fdb454b88eafe.png","工作细胞-团建":"https://i0.hdslb.com/bfs/emote/495a6cc5529bb64933a464a5160ae61ae35481c3.png","工作细胞-想不起来":"https://i0.hdslb.com/bfs/emote/dda84a1500a5a9af131cc265079a01f25c34c577.png","工作细胞-辛苦了":"https://i0.hdslb.com/bfs/emote/c34d1b2409bc5c7161c4d46543a79d3e27c09fac.png","工作细胞-中暑":"https://i0.hdslb.com/bfs/emote/1486b91e70d5dcdb50ac7f36cbb9603a62ca06a4.png"},
      path: window.location.pathname,
      visitor: true
    }, {"placeholder":"要不打点什么的东西?","recordIP":true,"enableQQ":true,"emojiCDN":"https://i0.hdslb.com/bfs/emote/"}))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/gh/HCLonely/Valine@latest/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Twikoo' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[image]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[link]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[code]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://blog-twikoo-ten.vercel.app',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "Unable to retrieve comments, please check the configuration"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'No comments'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script>(() => {
  const isChatBtn = true
  const isChatHideShow = true

  if (isChatBtn) {
    const close = () => {
      Chatra('minimizeWidget')
      Chatra('hide')
    }

    const open = () => {
      Chatra('openChat', true)
      Chatra('show')
    }

    window.ChatraSetup = {
      startHidden: true
    }
  
    window.chatBtnFn = () => {
      const isShow = document.getElementById('chatra').classList.contains('chatra--expanded')
      isShow ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        Chatra('hide')
      },
      show: () => {
        Chatra('show')
      }
    }
  }

  (function(d, w, c) {
    w.ChatraID = 'M5fnBvYBprT64WyMZ'
    var s = d.createElement('script')
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments)
    }
    s.async = true
    s.src = 'https://call.chatra.io/chatra.js'
    if (d.head) d.head.appendChild(s)
  })(document, window, 'Chatra')

})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>